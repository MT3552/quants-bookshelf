<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quant's Bookshelf</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sortable:hover {
            cursor: pointer;
            background-color: #4A5568; /* gray-700 */
        }
        .sort-asc::after {
            content: ' ▲';
            font-size: 0.8em;
        }
        .sort-desc::after {
            content: ' ▼';
            font-size: 0.8em;
        }
        /* Hide scrollbar for checkbox container */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .clickable-row:hover {
            cursor: pointer;
            background-color: rgba(74, 85, 104, 0.5); /* gray-700 with opacity */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white">Quant's Bookshelf</h1>
            <p class="text-md text-gray-400 mt-1">by Martin Tonikyan, PhD</p>
        </header>
        
        <div class="flex flex-col sm:flex-row justify-center items-center mb-8 gap-4">
            <input type="text" id="searchInput" placeholder="Search by title or author..." class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 w-full max-w-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <select id="categoryFilter" class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 w-full max-w-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="all">All Categories</option>
                </select>

            <div class="relative w-full max-w-xs">
                <button id="tagFilterButton" class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 w-full text-left focus:outline-none focus:ring-2 focus:ring-blue-500 flex justify-between items-center">
                    <span id="tagFilterButtonText">All Tags</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="tagFilterDropdown" class="hidden absolute z-10 mt-1 w-full bg-gray-800 border border-gray-700 rounded-lg shadow-lg max-h-60 overflow-y-auto no-scrollbar">
                    </div>
            </div>
        </div>

        <div class="overflow-x-auto bg-gray-800 rounded-lg shadow">
            <table class="min-w-full">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable" data-sort="title">Title</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable" data-sort="author">Author</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Tags</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable" data-sort="category">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable" data-sort="difficulty">Difficulty</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Cover</th>
                    </tr>
                </thead>
                <tbody id="book-table-body" class="divide-y divide-gray-700">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // =================================================================
        // === Your Amazon Associate Tag is set here =======================
        // =================================================================
        const YOUR_AMAZON_ASSOCIATE_TAG = 'martintphd-20';

        const books = [
            // ACTION REQUIRED: Replace 'XXXXXXXXXX' with the book's 10-digit ISBN or ASIN from Amazon
            // Finance
            { title: "Options, Futures, and Other Derivatives", author: "John Hull", tags: ["Derivatives", "Finance - General"], category: "Finance", difficulty: "Intermediate", asin: "013447208X" },
            { title: "Paul Wilmott Introduces Quantitative Finance", author: "Paul Wilmott", tags: ["Quantitative Trading", "Finance - General"], category: "Finance", difficulty: "Introductory", asin: "0470319585" },
            { title: "The Concepts and Practice of Mathematical Finance", author: "Mark Joshi", tags: ["Financial Mathematics", "Derivatives"], category: "Finance", difficulty: "Intermediate", asin: "0521514083" },
            { title: "Advanced Portfolio Management: A Quant's Guide", author: "Giuseppe A. Paleologo", tags: ["Portfolio Management", "Quantitative Trading"], category: "Finance", difficulty: "Advanced", asin: "1119792439" },
            { title: "Inside the Black Box", author: "Rishi K. Narang", tags: ["Quantitative Trading", "Market Microstructure"], category: "Finance", difficulty: "Intermediate", asin: "1118362413" },
            { title: "Quantitative Portfolio Management", author: "Michael Isichenko", tags: ["Portfolio Management", "Statistics"], category: "Finance", difficulty: "Advanced", asin: "3030522203" },
            { title: "Dynamic Hedging: Managing Vanilla and Exotic Options", author: "Nassim Nicholas Taleb", tags: ["Derivatives", "Volatility", "Hedging"], category: "Finance", difficulty: "Advanced", asin: "0471152803" },
            { title: "Active Portfolio Management", author: "Grinold & Kahn", tags: ["Portfolio Management", "Asset Pricing"], category: "Finance", difficulty: "Advanced", asin: "0070248826" },
            { title: "Trades, Quotes and Prices: Financial Markets Under the Microscope", author: "Bouchaud, Bonart, Donier, Gould", tags: ["Market Microstructure", "Economics"], category: "Finance", difficulty: "Advanced", asin: "1107128236" },
            { title: "Interest Rate Modelling (Vols 1-3)", author: "Andersen & Piterberg", tags: ["Interest Rates", "Derivatives"], category: "Finance", difficulty: "Advanced", asin: "0984422102" },
            { title: "Pricing and Trading Interest Rate Derivatives", author: "J H M Darbyshire", tags: ["Interest Rates", "Derivatives"], category: "Finance", difficulty: "Advanced", asin: "111983607X" },
            { title: "Interest Rate Models - Theory and Practice", author: "Damiano Brigo, Fabrizio Mercurio", tags: ["Interest Rates", "Credit", "Inflation"], category: "Finance", difficulty: "Advanced", asin: "3540221492" },
            { title: "Efficient Methods For Valuing Interest Rate Derivatives", author: "Antoon Pelsser", tags: ["Interest Rates", "Derivatives"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Interest-Rate Option Models", author: "Riccardo Rebonato", tags: ["Interest Rates", "Derivatives", "Volatility"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Foreign Exchange Option Pricing for Practitioners", author: "Iain J. Clark", tags: ["FX", "Derivatives"], category: "Finance", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "FX Options and Smile Risk", author: "Antonio Castagna", tags: ["FX", "Volatility", "Derivatives"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "FX Options and Structured Products", author: "Uwe Wystup", tags: ["FX", "Derivatives"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Option Volatility and Pricing", author: "Sheldon Natenberg", tags: ["Volatility", "Derivatives", "Equities"], category: "Finance", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Stochastic Volatility Modelling", author: "Lorenzo Bergomi", tags: ["Volatility", "Stochastic Processes", "Equities"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Security Analysis: Principles and Technique", author: "Graham & Dodd", tags: ["Equities", "Fundamental Trading"], category: "Finance", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Modelling Single-name and Multi-name Credit Derivatives", author: "Dominic O'Kane", tags: ["Credit", "Derivatives"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Credit Risk: Modeling, Valuation and Hedging", author: "Bielecki & Rutkowski", tags: ["Credit Risk", "Derivatives"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Commodity Option Pricing for Practitioners", author: "Iain J. Clark", tags: ["Commodities", "Derivatives"], category: "Finance", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Commodities and Commodity Derivatives", author: "Hélyette Geman", tags: ["Commodities", "Derivatives"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Energy and Power Risk Management", author: "Eydeland & Wolyniec", tags: ["Commodities", "Risk Management"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "The Handbook of Fixed Income Securities", author: "Frank J. Fabozzi", tags: ["Fixed Income", "Bonds"], category: "Finance", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Bond Markets, Analysis, and Strategies", author: "Frank J. Fabozzi", tags: ["Fixed Income", "Bonds"], category: "Finance", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Mortgage-Backed Securities", author: "Frank J. Fabozzi", tags: ["Credit", "Fixed Income"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Mortgage Valuation Models", author: "Davidson & Lewis", tags: ["Credit", "Fixed Income", "Valuation"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "The xVA Challenge", author: "Jon Gregory", tags: ["Credit Risk", "Derivatives"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Modelling, Pricing, and Hedging Counterparty Credit Exposure", author: "Cesari et al.", tags: ["Credit Risk", "Derivatives"], category: "Finance", difficulty: "Advanced", asin: "XXXXXXXXXX" },

            // Mathematics
            { title: "Introduction to Linear Algebra", author: "Gilbert Strang", tags: ["Linear Algebra"], category: "Mathematics", difficulty: "Introductory", asin: "XXXXXXXXXX" },
            { title: "Linear Algebra Done Right", author: "Sheldon Axler", tags: ["Linear Algebra"], category: "Mathematics", difficulty: "Introductory", asin: "XXXXXXXXXX" },
            { title: "A Course in Probability Theory", author: "Kai Lai Chung", tags: ["Probability", "Measure Theory"], category: "Mathematics", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Probability with Martingales", author: "David Williams", tags: ["Probability", "Stochastic Processes"], category: "Mathematics", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "An Introduction to Probability Theory and Its Applications", author: "William Feller", tags: ["Probability"], category: "Mathematics", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Probability and Random Processes", author: "Grimmett & Stirzaker", tags: ["Probability", "Stochastic Processes"], category: "Mathematics", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Probability Theory: A Comprehensive Course", author: "Achim Klenke", tags: ["Probability", "Measure Theory"], category: "Mathematics", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Probability and Measure", author: "Patrick Billingsley", tags: ["Probability", "Measure Theory"], category: "Mathematics", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Probability Essentials", author: "Jean Jacod, Philip Protter", tags: ["Probability"], category: "Mathematics", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Stochastic Calculus for Finance II: Continuous-Time Models", author: "Steven E. Shreve", tags: ["Stochastic Processes", "Financial Mathematics"], category: "Mathematics", difficulty: "Advanced", asin: "0387401016" },
            { title: "Stochastic Calculus for Finance I: The Binomial Asset Pricing Model", author: "Steven E. Shreve", tags: ["Stochastic Processes", "Financial Mathematics"], category: "Mathematics", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Arbitrage Theory in Continuous Time", author: "Tomas Björk", tags: ["Stochastic Processes", "Asset Pricing"], category: "Mathematics", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Introduction To Stochastic Calculus With Applications", author: "Fima C. Klebaner", tags: ["Stochastic Processes"], category: "Mathematics", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Brownian Motion and Stochastic Calculus", author: "Karatzas & Shreve", tags: ["Stochastic Processes"], category: "Mathematics", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Martingale Methods in Financial Modelling", author: "Musiela & Rutkowski", tags: ["Stochastic Processes", "Financial Mathematics"], category: "Mathematics", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Convex Optimization", author: "Boyd & Vandenberghe", tags: ["Optimization"], category: "Mathematics", difficulty: "Advanced", asin: "0521833787" },
            { title: "Principles of Mathematical Analysis", author: "Walter Rudin", tags: ["Real Analysis"], category: "Mathematics", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Understanding Analysis", author: "Stephen Abbott", tags: ["Real Analysis"], category: "Mathematics", difficulty: "Introductory", asin: "XXXXXXXXXX" },
            { title: "Financial Calculus: An Introduction to Derivative Pricing", author: "Baxter & Rennie", tags: ["Financial Mathematics"], category: "Mathematics", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Introduction to the Mathematics of Finance", author: "R. J. Williams", tags: ["Financial Mathematics"], category: "Mathematics", difficulty: "Introductory", asin: "XXXXXXXXXX" },

            // Statistics and Machine Learning
            { title: "Statistical Inference", author: "Casella & Berger", tags: ["Statistics", "Probability"], category: "Statistics and Machine Learning", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Introduction to Probability", author: "Tsitsiklis & Bertsekas", tags: ["Probability", "Statistics"], category: "Statistics and Machine Learning", difficulty: "Introductory", asin: "XXXXXXXXXX" },
            { title: "Introduction to Probability", author: "Blitzstein & Hwang", tags: ["Probability", "Statistics"], category: "Statistics and Machine Learning", difficulty: "Introductory", asin: "XXXXXXXXXX" },
            { title: "The Elements of Statistical Learning", author: "Hastie, Tibshirani & Friedman", tags: ["Machine Learning", "Statistics"], category: "Statistics and Machine Learning", difficulty: "Advanced", asin: "0387848576" },
            { title: "Advances in Financial Machine Learning", author: "Marcos López de Prado", tags: ["Machine Learning", "Portfolio Management"], category: "Statistics and Machine Learning", difficulty: "Advanced", asin: "1119482089" },
            { title: "Mathematics for Machine Learning", author: "Deisenroth, Faisal, Ong", tags: ["Machine Learning", "Linear Algebra", "Optimization"], category: "Statistics and Machine Learning", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Speech and Language Processing", author: "Jurafsky & Martin", tags: ["Machine Learning", "NLP"], category: "Statistics and Machine Learning", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Machine Learning in Finance: From Theory to Practice", author: "Dixon, Halperin, Bilokon", tags: ["Machine Learning", "Quantitative Trading"], category: "Statistics and Machine Learning", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Foundations of Reinforcement Learning with Applications in Finance", author: "Rao & Jelvis", tags: ["Reinforcement Learning", "Machine Learning"], category: "Statistics and Machine Learning", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Statistics and Data Analysis for Financial Engineering", author: "Ruppert & Matteson", tags: ["Statistics", "Data Analysis", "R"], category: "Statistics and Machine Learning", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Market Models: A Guide to Financial Data Analysis", author: "Carol Alexander", tags: ["Statistics", "Data Analysis"], category: "Statistics and Machine Learning", difficulty: "Intermediate", asin: "XXXXXXXXXX" },

            // Programming
            { title: "Monte Carlo Methods in Financial Engineering", author: "Paul Glasserman", tags: ["Simulations", "Financial Mathematics"], category: "Programming", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "C++ Design Patterns and Derivatives Pricing", author: "Mark S. Joshi", tags: ["C++", "Derivatives", "Quant Dev"], category: "Programming", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Implementing Derivative Models", author: "Strickland & Clewlow", tags: ["C++", "Derivatives", "Quant Dev"], category: "Programming", difficulty: "Advanced", asin: "XXXXXXXXXX" },
            { title: "Effective C++", author: "Scott Meyers", tags: ["C++", "Quant Dev"], category: "Programming", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Effective Modern C++", author: "Scott Meyers", tags: ["C++", "Quant Dev"], category: "Programming", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "The C++ Programming Language", author: "Bjarne Stroustrup", tags: ["C++"], category: "Programming", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "C++ Primer", author: "Lippman, Lajoie, Moo", tags: ["C++"], category: "Programming", difficulty: "Introductory", asin: "0321714113" },

            // Career
            { title: "Heard on the Street: Quantitative Questions", author: "Timothy Falcon Crack", tags: ["Interview Prep"], category: "Career", difficulty: "Intermediate", asin: "097005525X" },
            { title: "Quant Job Interview Questions And Answers", author: "Joshi, Denson, Downes", tags: ["Interview Prep"], category: "Career", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "Quantitative Finance Interview Guide", author: "Canary Wharfian", tags: ["Interview Prep"], category: "Career", difficulty: "Intermediate", asin: "XXXXXXXXXX" },
            { title: "A Random Walk Down Wall Street", author: "Burton G. Malkiel", tags: ["Career", "Finance - General"], category: "Career", difficulty: "Introductory", asin: "XXXXXXXXXX" },
            { title: "Fooled by Randomness", author: "Nassim Nicholas Taleb", tags: ["Career", "Probability"], category: "Career", difficulty: "Introductory", asin: "XXXXXXXXXX" },

            // Industry - General
            { title: "My Life as a Quant", author: "Emanuel Derman", tags: ["Biography", "Industry"], category: "Industry - General", difficulty: "Introductory", asin: "0471394203" },
            { title: "The Man Who Solved the Market", author: "Gregory Zuckerman", tags: ["Biography", "Industry"], category: "Industry - General", difficulty: "Introductory", asin: "0735217980" },
            { title: "Trading at the Speed of Light", author: "Donald MacKenzie", tags: ["Industry", "Market Microstructure"], category: "Industry - General", difficulty: "Introductory", asin: "XXXXXXXXXX" },
            { title: "The Quants", author: "Scott Patterson", tags: ["Industry", "History"], category: "Industry - General", difficulty: "Introductory", asin: "XXXXXXXXXX" },
            { title: "Liar's Poker", author: "Michael Lewis", tags: ["Industry", "Biography"], category: "Industry - General", difficulty: "Introductory", asin: "039333869X" },
        ];

        // DOM Elements
        const bookTableBody = document.getElementById('book-table-body');
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const tableHeaders = document.querySelectorAll('th.sortable');
        const tagFilterButton = document.getElementById('tagFilterButton');
        const tagFilterButtonText = document.getElementById('tagFilterButtonText');
        const tagFilterDropdown = document.getElementById('tagFilterDropdown');

        // State
        let sortState = { column: 'title', direction: 'asc' };
        let selectedTags = [];

        const fetchBookCover = async (title, author) => {
            try {
                const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(title)}+inauthor:${encodeURIComponent(author.split(/[,&]/)[0])}`);
                const data = await response.json();
                if (data.items && data.items.length > 0) {
                    return data.items[0].volumeInfo.imageLinks?.thumbnail || 'https://placehold.co/80x120/374151/9CA3AF?text=No+Cover';
                }
            } catch (error) {
                console.error('Error fetching book cover:', error);
            }
            return 'https://placehold.co/80x120/374151/9CA3AF?text=No+Cover';
        };

        const renderBooks = async (booksToRender) => {
            bookTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500 mx-auto"></div><p class="mt-2">Loading book covers...</p></td></tr>`;
            
            const rows = await Promise.all(booksToRender.map(async book => {
                const coverUrl = await fetchBookCover(book.title, book.author);
                const difficultyColor = book.difficulty === 'Advanced' ? 'text-red-400' : book.difficulty === 'Intermediate' ? 'text-yellow-400' : 'text-green-400';
                const amazonLink = `https://www.amazon.com/dp/${book.asin}/?tag=${YOUR_AMAZON_ASSOCIATE_TAG}`;
                
                return `
                    <tr class="clickable-row" onclick="window.open('${amazonLink}', '_blank')">
                        <td class="px-6 py-4 align-top"><div class="text-sm font-medium text-white">${book.title}</div></td>
                        <td class="px-6 py-4 align-top whitespace-nowrap text-sm">${book.author}</td>
                        <td class="px-6 py-4 align-top"><div class="flex flex-wrap gap-1">${book.tags.map(tag => `<span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-600 text-gray-200">${tag}</span>`).join(' ')}</div></td>
                        <td class="px-6 py-4 align-top whitespace-nowrap text-sm">${book.category}</td>
                        <td class="px-6 py-4 align-top whitespace-nowrap text-sm font-medium ${difficultyColor}">${book.difficulty}</td>
                        <td class="px-6 py-4 align-top text-sm"><img src="${coverUrl}" alt="Cover for ${book.title}" class="h-24 w-auto rounded-md shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/80x120/374151/9CA3AF?text=Error';"></td>
                    </tr>
                `;
            }));
            bookTableBody.innerHTML = rows.join('');
            if (rows.length === 0) {
                 bookTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">No books found matching your criteria.</td></tr>';
            }
        };

        const updateSortUI = () => {
            tableHeaders.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (header.dataset.sort === sortState.column) {
                    header.classList.add(sortState.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        };

        const filterAndSortAndRender = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            selectedTags = Array.from(tagFilterDropdown.querySelectorAll('input:checked')).map(cb => cb.value);
            
            tagFilterButtonText.textContent = selectedTags.length === 0 ? 'All Tags' : `${selectedTags.length} Tag(s) selected`;

            let processedBooks = books.filter(book => {
                const titleMatch = book.title.toLowerCase().includes(searchTerm);
                const authorMatch = book.author.toLowerCase().includes(searchTerm);
                const categoryMatch = selectedCategory === 'all' || book.category === selectedCategory;
                const tagMatch = selectedTags.length === 0 || selectedTags.every(tag => book.tags.includes(tag));
                return (titleMatch || authorMatch) && categoryMatch && tagMatch;
            });

            processedBooks.sort((a, b) => {
                const valA = a[sortState.column].toLowerCase();
                const valB = b[sortState.column].toLowerCase();
                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });

            renderBooks(processedBooks);
            updateSortUI();
        };

        const categories = [...new Set(books.map(book => book.category))].sort();
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categoryFilter.appendChild(option);
        });

        const allTags = [...new Set(books.flatMap(book => book.tags))].sort();
        allTags.forEach(tag => {
            const checkboxContainer = document.createElement('label');
            checkboxContainer.className = 'flex items-center px-4 py-2 hover:bg-gray-700 cursor-pointer';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = tag;
            checkbox.className = 'form-checkbox h-4 w-4 bg-gray-800 border-gray-600 rounded text-blue-500 focus:ring-blue-500';
            checkbox.addEventListener('change', filterAndSortAndRender);
            const label = document.createElement('span');
            label.className = 'ml-2 text-sm';
            label.textContent = tag;
            checkboxContainer.appendChild(checkbox);
            checkboxContainer.appendChild(label);
            tagFilterDropdown.appendChild(checkboxContainer);
        });

        tableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortColumn = header.dataset.sort;
                if (sortState.column === sortColumn) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.column = sortColumn;
                    sortState.direction = 'asc';
                }
                filterAndSortAndRender();
            });
        });

        searchInput.addEventListener('input', filterAndSortAndRender);
        categoryFilter.addEventListener('change', filterAndSortAndRender);

        tagFilterButton.addEventListener('click', (e) => {
            e.stopPropagation();
            tagFilterDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!tagFilterButton.contains(e.target) && !tagFilterDropdown.contains(e.target)) {
                tagFilterDropdown.classList.add('hidden');
            }
        });

        filterAndSortAndRender();
    </script>

</body>
</html>
